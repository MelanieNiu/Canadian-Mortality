---
title: "My title"
subtitle: "My subtitle if needed"
author: 
  - First author
  - Another author
thanks: "Code and data are available at: LINK."
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(knitr)
library(rstanarm)
library(modelsummary)

```


# Introduction 



The remainder of this paper is structured as follows. In @sec-data, we showed the data and methodology utilized in this study. @sec-model discusses the model used to analyze the data

# Data {#sec-data}

R [@citeR] was the language and environment used for the bulk of this analysis, alongside the tidyverse [@thereferencecanbewhatever], knitr[@knitr] , ggplot2[@Wickham2016ggplot2] have been used in data cleaning and visualization. 


```{r}
#| label: Tbl-1
#| fig-cap: Top-ten causes of death in Canada in 2022
#| echo: false

cleaned_data <- read.csv("../data/cleaned_data.csv")

transformed_data <- cleaned_data %>%
  filter(Ranking <= 10) %>%
  add_count(Cause) %>%
  filter(Year == 2021) %>%
  arrange(Ranking) %>%
  mutate(Death = format(Death, big.mark = ","))

transformed_data %>%
  kable(
    col.names = c("Year", "Cause", "Death", "Ranking", "Counts"),
    align = c("l", "r", "r", "r", "r"),
    digits = 0, booktabs = TRUE, linesep = ""
  )


```


```{r}
#| label: Fig-1
#| fig-cap: Annual number of deaths for the top-five causes in 2021, since 2001, for Canada
#| echo: false
#| warning: false
#| message: false

canada_top_five <-
  transformed_data |>
  filter(
    Year == 2022, 
    n == 22
  ) |>
  slice_max(order_by = desc(Ranking), n = 5) |>
  pull(Cause)

analysis_data <- cleaned_data |>
  filter(Cause %in% canada_top_five) 

analysis_data |>
  ggplot(aes(x = Year, y = Death, color = Cause)) +
  geom_line() +
  theme_minimal() +
  labs(x = "Year", y = "Annual number of deaths in Canada") +
  facet_wrap(vars(Cause), dir = "v", ncol = 1) +
  theme(legend.position = "none")

```

```{r}
#| label: Tbl-2
#| fig-cap: Summary Statistics of the number of yearly deaths, by cause, in Canada
#| echo: false

datasummary(Death ~ Min + Mean + Max + SD + Var + N,
            fmt = 0,
            data = analysis_data)
```
@tbl-2 shows that the mean, 32,603, is different to the variance 673,243,267. 


```{r}
#| label: tbl-3
#| fig-cap: Modeling the most prevalent cause of deaths in Canada, 2001-2022
#| echo: false
#| warning: false
#| message: false

canada_death_poisson <- readRDS("../models/canada_death_poisson.rds")
canada_death_negbinomial <- readRDS("../models/canada_death_negbinomial.rds")

coef_short_names <- c(
  "(Intercept)" = "(Intercept)",
  "CauseCerebrovascular diseases " = "Cerebrovascular diseases",
  "CauseChronic lower respiratory diseases " = "Chronic lower respiratory diseases",
  "CauseDiseases of heart " = "Diseases of heart",
  "CauseMalignant neoplasms " = "Malignant neoplasms"
)


modelsummary(
  list(
    "Poisson" = canada_death_poisson,
    "Negative binomial" = canada_death_negbinomial
  ),
  coef_map = coef_short_names,
  statistic = "std.error"
)

```
# Model

The goal of our modelling strategy is twofold. 
Firstly,...
we would like to model the mortality in Canada. 

Here we briefly describe the Bayesian analysis model used to investigate... 

We model the incidences of death by one of the leading cause of deaths using a Poisson regression model and a negative Binomial regression model. Background details and diagnostics are included in [Appendix -@sec-model-details].

R packages rstanarm[@rstanarm] and modelsummary [@model] are used to build and analyze the models.

## Model set-up

In our Poisson model, define $y_i$ as the number of deaths in a year due to a leading cause of death. Then $\lambda_i$ is the average rate of deaths due to this cause per year. $\lambda_i$ is linked to the predictor $x_i$ for the $i$th observation by a log link function where $\beta_0$ is the intercept and $\beta_1$ is the coefficient. We specifiy prior distributions for the parameters $\beta_0$ and $\beta_1$ in Bayesian analysis. We choose $\beta_0$ and $\beta_1$ to follow a normal distribution with mean 0 and conservative standard deviation of 2.5. 

\begin{align} 
y_i&\sim \text{Poisson}(\lambda_i) \quad \text{(1)} \\
\text{log}(\lambda_i) &= \beta_0 + \beta_1 X_i \quad \text{(2)} \\
\beta_0 &\sim \text{Normal}(0, 2.5) \quad \text{(3)} \\
\beta_1 &\sim \text{Normal}(0, 2.5) \quad \text{(4)} \\
\end{align}

We run the model in R [@citeR] using the `rstanarm` package of @rstanarm. We use the default priors from `rstanarm`.

In our negative binomial model, similarly define $y_i$ as the number of deaths due to a leading cause of death in a year. Then $\mu_i$ is the average count of deaths in a year. $\mu_i$ is linked to the predictor cause of death $x_i$ by a log link function with the intercept $\beta_0$ and the coefficient $\beta_i$. $\phi_i$ is the dispersion of the distribution measuring the extent of deviation from the count expected under a Poisson distribution. We specifiy the prior distributions for $\beta_0$ and $\beta_1$ to follow a normal distribution with mean 0 and conservative standard deviation of 2.5. We specify the prior of $\phi_i$ to follow a gamma distribution.

\begin{align} 
y_i&\sim \text{NegativeBinomial}(\mu, \phi) \quad \text{(1)} \\
\text{log}(\mu_i) &= \beta_0 + \beta_1 X_i \quad \text{(2)} \\
\beta_0 &\sim \text{Normal}(0, 2.5) \quad \text{(3)} \\
\beta_1 &\sim \text{Normal}(0, 2.5) \quad \text{(4)} \\
\phi &\sim \text{Gamma}(2, 0.1) \quad \text{5} \\
\end{align}

### Model justification

Since the residual of the number of deaths by a leading cause in a year does not follow a normal distribution, we consider using a generalized linear regression model. Since mortality occurrences are discrete events, we consider the Poisson regression model and its variant, negative binomial regression model, both of which relate explanatory variables to dependent variables representing counts of events (Reference: Poisson for aggregate data). Table 2 shows that the mean and variance are not the same. This indicates dispersion in the data, therefore negative binomial regression model may be more suitable. 


# Results

Our results are summarized in @tbl-modelresults.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

library(rstanarm)

first_model <-
  readRDS(file = here::here("models/first_model.rds"))
```


Table X presents the coefficients for various causes from both the Poisson and the Negative Binomial regression models.
The intercept represents the baseline of the model, in this case, Accidents (unintentional injuries). It shows the log count of deaths when all other causes of death are at this reference level, i.e. when no one other specific cause is considered.

The coefficients for specific causes such as cerebrovascular diseases, chronic lower respiratory diseases, diseases of heart, and malignant neoplasms reflect the log-relative difference in the count of deaths relative to the reference level. Since we used a log link function, the coefficients represent effects on the log scale. Positive coefficients therefore indicate positive association between the cause and the number of deaths.

Table shows that among the top five leading causes of death in Canada, diseases of the heart with a coefficient of 1.454 and malignant neoplasms with a coefficient of approximately 1.805 significantly indicates a strong positive association in both models. The coefficient for Diseases of heart is 1.454 in both the Poisson model and the negative binomial model. Exponentiating the coefficient 1.454 to obtain `r round(exp(1.454),2)` suggests that the expected count of deaths due to Diseases of the heart is about `r round(exp(1.454) - 1,2)` times higher than the baseline category Accidents (unintentional injuries). Similarly, exponentiating the coefficient for malignant neoplasms to obtain `r round(exp(1.805),2)` shows the expected count of deaths is `r round(exp(1.805)-1, 2)` times higher Accidents (unintentional injuries). Conversely, chronic lower respiratory diseases are associated with a slight decrease in mortality compared to Accidents (unintentional injuries) with a coefficient of -0.070 in the Poisson model, although the impact is modest about `r round(1-exp(-0.070),2)` less. Both the Poisson model and the negative binomial model yielded similar coefficients. 

This similarity suggests that both models are capturing similar relationship between the causes and the number of deaths. Comparing the Log Likelihood, The Negative Binomial model has a much higher (less negative) value -1050.577 than the Poisson model -16957.794. A higher log likelihood indicates a better model fit thus our analysis suggests the Negative Binomial model fits the data better. The other measures ELPD, LOOIC WAIC and RMSE all suggest that the negative binomial model fits the data better @sec-model-details

```{r}

poisson <- kfold(canada_death_poisson, k = 10)
neg_binomial <- kfold(canada_death_negbinomial, k = 10)

loo_compare(poisson, neg_binomial)

```
# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}

# Additional data details {#sec-data-details}

```{r}
#| label: tbl-5
#| fig-cap: A sample of the cleaned dataset, 2001-2022
#| echo: false
#| warning: false
#| message: false
sampled_data <- sample_n(cleaned_data, 5) %>%
  kable()
sampled_data
```



# Model details {#sec-model-details}

## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check for the Poisson regression model described in @sec-4. This shows predictions generated from the posterior distribution of the model parameters (represented by the light blue lines) align reasonably well with the actual data (represented by the dark blue line) with minor misalignment. This suggests the model represent the data well.

In @fig-ppcheckandposteriorvsprior-2 we implement a posterior predictive check for the negative binomial regression model described in @sec-4. This shows predictions generated from the posterior distribution of the model parameters (represented by the light blue lines) align generally well with the actual data (represented by the dark blue line). This suggests the model represents the data well. 


```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Comparing posterior prediction checks for Poisson and negative binomial models"
#| fig-subcap: ["Poisson model", "Negative binomial model"]

pp_check(canada_death_poisson) +
  theme(legend.position = "bottom")

pp_check(canada_death_negbinomial) +
  theme(legend.position = "bottom")
```


## Diagnostics
```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Comparing posterior prediction checks for Poisson and negative binomial models"
#| fig-subcap: ["Poisson model", "Negative binomial model"]

pp_check(canada_death_poisson) +
  theme(legend.position = "bottom")

pp_check(canada_death_negbinomial) +
  theme(legend.position = "bottom")
```

@fig-stanareyouokay-1 is a trace plot for the Poisson regression model. It shows a horizontal, dense band of samples without any systematic patterns, drifts, or long periods of stagnation. This pattern suggests that the chain is mixing well and sampling efficiently from the posterior distribution. This suggests the Poisson regression model is suitable.

@fig-stanareyouokay-2 is a Rhat plot. It shows an Rhat value close to 1.  This suggests that the chains have converged to the target distribution. 

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-stanareyouokay-a
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2

plot(canada_death_poisson, "trace")
plot(canada_death_poisson, "rhat")

```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-stanareyouokay-b
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2


plot(canada_death_negbinomial, "trace")
plot(canada_death_negbinomial, "rhat")
```

@fig-stanareyouokay-b-1 is a trace plot for the negative binomial regression model. It also shows a horizontal, dense band of samples without abnormalities suggesting the chain is mixing well and sampling efficiently from the posterior distribution. This suggests the negative binomial model is suitable.

@fig-stanareyouokay-b-2 is a Rhat plot for the negative binomial regression model. It shows an Rhat value close to 1.  This again suggests that the chains have converged to the target distribution in the negative regression model.

\newpage


# References


